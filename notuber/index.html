<!DOCTYPE html>

<html>

  <head>
    <title>{No Tuber}</title>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDwfO3Kf3o6Za1tJRSFA6sjEYoRCYXatlM&callback=getMyLocation"
    async defer></script>
    <!-- <script src="https://maps.googleapis.com/maps/api/js?libraries=geometry"
    async defer></script> -->

  
    <script>

       var username = "cKkHI7M4Ux";
       var me;
       var map;
       myOptions = {
          center: me,
          zoom: 13,
          mapTypeId: google.maps.MapTypeId.ROADMAP,
          };


      function getMyLocation()
        {
          if (navigator.geolocation)
            { 
              navigator.geolocation.getCurrentPosition(function(position) {
                myLat = position.coords.latitude;
                myLng = position.coords.longitude;

                me = new google.maps.LatLng(myLat, myLng);
                
                initMap(me);
              });
            }

            else 
            {
              document.getElementById("map_canvas").innerHTML = "Geolocation disabled :(";
            }
        }

      //function to initialize map
      function initMap(me)
        {   
            // Create the map in the "map_canvas" <div>
            map = new google.maps.Map(document.getElementById("map_canvas"));
            map.setCenter(me);
            map.setZoom(15);
            setMyMarker(map, me);
        }

      //set me at my position using spiderman as me
      function setMyMarker(map, me)
        {
          var myMarker = new google.maps.Marker(
          {
            position: me,
            title: username + "</br>" + " Distance to nearest marker: ",
            icon: "spiderman.png",
            animation: google.maps.Animation.DROP
          });
          
          myMarker.setMap(map);
          
          //global info window
          
          var infowindow = new google.maps.InfoWindow();
          // Open info window on click of marker
          google.maps.event.addListener(myMarker, 'click', function() {
            infowindow.setContent(myMarker.title);
            infowindow.open(map, myMarker);
          });
          requestData(map, myMarker, me);
        }

      function requestData(map, myMarker, me)
        {
          var request = new XMLHttpRequest();
          request.open('POST', "https://jordan-marsh.herokuapp.com/rides", true);
          request.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
          request.onload = function () 
          {
              data = JSON.parse(this.responseText);
              if(data.vehicles)
              {
                vehicles(map, myMarker, me, data, username)
              }

              else if(data.passengers)
              {
                passengers(map, myMarker, me, data, username)
              }
          };
          request.send("username=" + username + "&lat=" + myLat + "&lng=" + myLng);
        }

        //iterates through data to set marker for each vehicle
        function vehicles(map, myMarker, me, data, username)
         {
          var infowindow = new google.maps.InfoWindow();
          for (i = 0; i < data.passengers.length; i++) 
            {
              var marker = new google.maps.Marker({
                  position: {lat: data.passengers[i].lat, lng: data.passengers[i].lng},
                  map: map,
                  title: data.passengers[i].username,
                  icon: "car.png",
                  animation: google.maps.Animation.DROP
                });
                name = data.passengers[i].username;
                google.maps.event.addListener(marker,'click', (function(marker,name,infowindow){ 
                      return function() 
                      {
                          infowindow.setContent(name);
                          infowindow.open(map,marker);
                      };
                  })(marker,name,infowindow));
                  };
            }

        //iterates through data to set marker for each passenger
        //passengers are potatos please dont ask why
        function passengers(map, myMarker, me, data, username)
        {
          var infowindow = new google.maps.InfoWindow();
          for (i = 0; i < data.passengers.length; i++) 
            {
              var marker = new google.maps.Marker({
                  position: {lat: data.passengers[i].lat, lng: data.passengers[i].lng},
                  map: map,
                  title: data.passengers[i].username,
                  icon: "potato.png",
                  animation: google.maps.Animation.DROP
                });
                name = data.passengers[i].username;
                google.maps.event.addListener(marker,'click', (function(marker,name,infowindow){ 
                      return function() 
                      {
                          infowindow.setContent(name);
                          infowindow.open(map,marker);
                      };
                  })(marker,name,infowindow));
                  };
            }


           // function findDistance()

  //if you must know it's because someone thought i was working on "No Tuber" and potatos are tubers so here we are
  </script>
  <link rel="stylesheet" href="style.css"/>
  </head>
  <body>
    <h1>No Tuber</h1>
    <div id="map_canvas"></div>
  </body>
</html>